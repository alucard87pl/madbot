# When someone opens an issue with the "Wiki request" template (label: wiki-request),
# parse the issue body and open a PR that adds the new wiki to src/wiki/wikis.ts targeting dev.

name: Wiki request PR

on:
  issues:
    types: [opened, labeled]

jobs:
  pr:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issues' &&
      (contains(github.event.issue.labels.*.name, 'wiki-request') ||
       (github.event.action == 'labeled' && github.event.label.name == 'wiki-request'))
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout dev
        uses: actions/checkout@v4
        with:
          ref: dev
          fetch-depth: 0

      - name: Parse issue body
        id: parse
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          node scripts/parse-wiki-request.mjs > wiki-line.txt
          echo "Parsed wiki entry:"
          cat wiki-line.txt

      - name: Add wiki entry to wikis.ts
        run: |
          node -e "
          const fs = require('fs');
          const line = fs.readFileSync('wiki-line.txt', 'utf8').trim();
          const path = 'src/wiki/wikis.ts';
          let content = fs.readFileSync(path, 'utf8');
          content = content.replace(/\];/, line + '\n];');
          fs.writeFileSync(path, content);
          "

      - name: Create branch and push
        id: push
        run: |
          BRANCH="wiki-request-${{ github.event.issue.number }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH"
          git add src/wiki/wikis.ts
          if git diff --staged --quiet; then echo "No change (duplicate or parse produced no diff)"; echo "pushed=false" >> $GITHUB_OUTPUT; exit 0; fi
          echo "pushed=true" >> $GITHUB_OUTPUT
          git commit -m "Add wiki from issue #${{ github.event.issue.number }}"
          git push origin "$BRANCH"

      - name: Open PR
        if: steps.push.outputs.pushed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUM: ${{ github.event.issue.number }}
          BRANCH: wiki-request-${{ github.event.issue.number }}
        run: |
          EXISTING=$(gh pr list --base dev --head "$BRANCH" --json number -q '.[0].number' 2>/dev/null || true)
          if [ -n "$EXISTING" ]; then echo "PR already exists: #$EXISTING"; exit 0; fi
          if gh pr create --base dev --head "$BRANCH" \
            --title "Add wiki: request from #$ISSUE_NUM" \
            --body "Automated PR from wiki request issue #$ISSUE_NUM. Please review the new wiki entry and merge into \`dev\` if it looks good. Closes #$ISSUE_NUM"; then
            echo "PR created with gh"
            exit 0
          fi
          echo "gh pr create failed, trying REST API..."
          PR_JSON=$(node -e "
            const body = 'Automated PR from wiki request issue #' + process.env.ISSUE_NUM + '. Please review the new wiki entry and merge into \\`dev\\` if it looks good. Closes #' + process.env.ISSUE_NUM;
            console.log(JSON.stringify({ title: 'Add wiki: request from #' + process.env.ISSUE_NUM, head: process.env.BRANCH, base: 'dev', body }));
          ")
          curl -sS -X POST -H "Authorization: token $GH_TOKEN" -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/pulls" -d "$PR_JSON" || true
